{% extends "script_app/base.html" %}
{% load form_tags %}
{% block title %}Script Generator{% endblock %}

{% block content %}
  <h1 class="mb-4">Script Generator</h1>
  <div class="form-container mt-5">
    <div id="sliderForm">
      <div class="step active">
        <h2>Select the product and target audience</h2>
        <form method="post" id="step1">
          {% csrf_token %}
          <div class="form-group">
            {{ message_form.product.label_tag }}<br>
            {{ message_form.product|add_class:"form-control" }}<br>
          </div>
          <div class="form-group">
            {{ message_form.audience.label_tag }}<br>
            {{ message_form.audience|add_class:"form-control" }}<br>
          </div>
          <div class="buttons">
            <button type="button" class="btn btn-primary btn-back" onclick="nextPrev(-1)" disabled>Back</button>
            <button type="button" class="btn btn-primary btn-next" onclick="nextPrev(1)">Next</button>
          </div>
        </form>
      </div>
      <div class="step">
        <h2>What problem(s) should the ad focus on?</h2>
        <form method="post" id="step2">
          {% csrf_token %}
          <div class="form-group">
            <div class="checkbox-group">
              {{ message_form.problem }}
            </div>
          </div>
          <div class="buttons">
            <button type="button" class="btn btn-primary btn-back" onclick="nextPrev(-1)">Back</button>
            <button type="button" class="btn btn-primary btn-next" onclick="nextPrev(1)">Next</button>
          </div>
        </form>
      </div>
      <div class="step">
        <h2>What Unique Selling Proposition(s) should the ad focus on?</h2>
        <form method="post" id="step3">
          {% csrf_token %}
          <div class="form-group">
            <div class="checkbox-group">
              {{ message_form.usp }}
            </div>
          </div>
          <div class="buttons">
            <button type="button" class="btn btn-primary btn-back" onclick="nextPrev(-1)">Back</button>
            <button type="button" class="btn btn-primary btn-next" onclick="nextPrev(1)">Next</button>
          </div>
        </form>
      </div>
      <div class="step">
        <h2>Would you like to add any additional context (e.g. style, theme, or a trend)?</h2>
        <form method="post" id="finalStep">
          {% csrf_token %}
          <div class="form-group">
            {{ message_form.additional_context|add_class:"form-control" }}<br>
          </div>
          <div class="buttons">
            <button type="button" class="btn btn-primary btn-back" onclick="nextPrev(-1)">Back</button>
            <button type="submit" class="btn btn-primary btn-next">Submit</button>
          </div>
        </form>
      </div>
    </div>
    <div class="step">
      <h2>Generated Messages</h2>
      <textarea id="generatedMessages" class="form-control" readonly rows="10"></textarea>
    </div>
  </div>

  <script>
    let currentStep = 0;
    const steps = document.querySelectorAll(".step");

    function showStep(n) {
      steps[currentStep].classList.remove("active");
      currentStep += n;

      if (currentStep >= steps.length) {
        return false;
      }

      steps[currentStep].classList.add("active");
    }

    showStep(0);

    function nextPrev(n) {
      showStep(n);
    }

    document.getElementById("finalStep").addEventListener("submit", function(event) {
      event.preventDefault();
      const nextBtn = steps[currentStep].querySelector(".btn-next");
      nextBtn.disabled = true;
      nextBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

      // Merge data from all steps
      const formData = new FormData();
      const step1Data = new FormData(document.getElementById("step1"));
      const step2Data = new FormData(document.getElementById("step2"));
      const step3Data = new FormData(document.getElementById("step3"));
      const finalStepData = new FormData(document.getElementById("finalStep"));

      for (let [key, value] of step1Data.entries()) {
        formData.append(key, value);
      }
      for (let [key, value] of step2Data.entries()) {
        formData.append(key, value);
      }
      for (let [key, value] of step3Data.entries()) {
        formData.append(key, value);
      }
      for (let [key, value] of finalStepData.entries()) {
        formData.append(key, value);
      }

      fetch("{% url 'generate_messages' %}", {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        nextBtn.disabled = false;
        nextBtn.innerHTML = "Submit";

        if (data.messages) {
          document.getElementById("generatedMessages").value = "--" + data.messages.join("\n\n--");
          showStep(1);
        } else {
          alert("Failed to generate messages. Please try again.");
        }
      })
      .catch(error => {
        nextBtn.disabled = false;
        nextBtn.innerHTML = "Submit";
        console.error('Error:', error);
        alert("An error occurred. Please try again.");
      });
    });
  </script>
{% endblock %}
